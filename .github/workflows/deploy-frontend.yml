name: Frontend CI/CD

# üöÄ Desplegament autom√†tic a EC2 quan hi ha canvis en 'frontend/'
on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
      - 'docker-compose.prod.yml'

  # Permet executar manualment des de GitHub Actions
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_N8N_WEBHOOK_URL: ${{ secrets.VITE_N8N_WEBHOOK_URL }}
        with:
          host: ${{ secrets.EC2_HOST }}  # IP del servidor (18.206.113.196)
          username: ${{ secrets.EC2_USER }} # 'ubuntu'
          key: ${{ secrets.EC2_SSH_KEY }} # Clau privada .pem
          script: |
            echo "--- üöÄ Iniciant desplegament Frontend ---"
            
            # Definir URL amb Token per a clonar si cal
            REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            
            if [ ! -d "/home/ubuntu/PI" ]; then
              echo "--- üì• Clonando repositorio por primera vez ---"
              git clone $REPO_URL /home/ubuntu/PI
            fi
            
            cd /home/ubuntu/PI
            
            echo "--- üì• Actualitzant codi ---"
            git remote set-url origin $REPO_URL
            git pull origin main
            
            echo "--- üê≥ Reconstruint i reiniciant contenidor ---"
            # Passar secrets com a build-args
            export VITE_API_URL=${{ secrets.VITE_API_URL }}
            export VITE_N8N_WEBHOOK_URL=${{ secrets.VITE_N8N_WEBHOOK_URL }}
            
            docker compose -f docker-compose.prod.yml up -d --build --force-recreate frontend
            
            echo "--- ‚úÖ Desplegament Frontend complet ---"
