# ═══════════════════════════════════════════════════════════════════════════════
# Docker Compose - PRODUCCIÓ
# Optimitzat per a desplegament en servidor AWS (EC2)
# Gestiona Fronend, Backend (Laravel + PHP-FPM + Nginx) i Base de Dades.
#
# Ports interns (no exposats a Internet directament, només a localhost):
# - Frontend: 8001
# - Backend API: 8002
# - MySQL: 3306 (només xarxa interna)
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─── FRONTEND (Vue + Nginx) ──────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /
        VITE_N8N_BASE_URL: http://18.206.113.196
    container_name: pi_prod_frontend
    ports:
      - "80:80"
    restart: always
    networks:
      - pi_network_prod

  # ─── BACKEND (PHP-FPM) ───────────────────────────────────────────────────
  laravel-app:
    build:
      context: ./laravel
      dockerfile: Dockerfile
    container_name: pi_prod_laravel_app
    volumes:
      - ./laravel:/var/www/laravel
      # Muntem configuració PHP personalitzada si cal
      # - ./laravel/docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - SANCTUM_STATEFUL_DOMAINS=18.206.113.196,localhost,127.0.0.1
      - SESSION_DOMAIN=18.206.113.196
      - APP_URL=http://18.206.113.196
      - APP_KEY=${APP_KEY}

    working_dir: /var/www/laravel
    restart: always
    networks:
      - pi_network_prod
    depends_on:
      db:
        condition: service_healthy

  # ─── BACKEND WESERVER (Nginx) ────────────────────────────────────────────
  laravel-nginx:
    image: nginx:stable-alpine
    container_name: pi_prod_laravel_nginx
    ports:
      - "127.0.0.1:8002:80"  # Només accessible des del host (reverse proxy SSL)
    volumes:
      - ./laravel:/var/www/laravel:ro
      - ./laravel/docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - laravel-app
    restart: always
    networks:
      - pi_network_prod

  # ─── BASE DE DADES (MySQL) ───────────────────────────────────────────────
  db:
    image: mysql:8.0
    container_name: pi_prod_db
    # No exposem port al host en producció per seguretat
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - prod_db_data:/var/lib/mysql
      - ./database:/docker-entrypoint-initdb.d # Asegurar scripts de inicialización
    networks:
      - pi_network_prod
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ─── N8N (Automatització i Chatbot) ──────────────────────────────────────
  n8n:
    image: n8nio/n8n:latest
    container_name: pi_prod_n8n
    ports:
      - "5678:5678" # Accesible por IP para configuración inicial
    environment:
      - N8N_HOST=18.206.113.196
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false
      - NODE_ENV=production
      - WEBHOOK_URL=http://18.206.113.196:5678/
      - GENERIC_TIMEZONE=Europe/Madrid
    volumes:
      - prod_n8n_data:/home/node/.n8n
      - ./n8n/workflows:/data/workflows
    networks:
      - pi_network_prod
    restart: always

# ─── VOLUMS ──────────────────────────────────────────────────────────────────
volumes:
  prod_db_data:
    name: pi_prod_db_data
  prod_n8n_data:
    name: pi_prod_n8n_data

# ─── XARXA ────────────────────────────────────────────────────────────────────

networks:
  pi_network_prod:
    driver: bridge
